<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Big Mac Prices</title>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://d3js.org/d3-geo.v1.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="https://d3js.org/d3-ease.v1.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/topojson@3.0.2/dist/topojson.min.js"></script>
    <style>
        body {
            background-color: black;
            margin: 0;
        }

        #map {
            width: 100%;
            height: 600px;
        }

        path {
            stroke: white;
            stroke-width: 0.5;
        }

        .tooltip {
            position: absolute;
            background-color: white;
            color: black;
            padding: 10px;
            opacity: 0;
            pointer-events: none;
        }

        .tooltip.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .line {
            fill: none;
            stroke: white;
            stroke-width: 2;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="tooltip" class="tooltip"></div>
    <script>
        const margin = { top: 20, right: 20, bottom: 30, left: 50 };
        const width = 600 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = d3.select('body').append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
            .append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);

        const x = d3.scaleTime().range([0, width]);
        const y = d3.scaleLinear().range([height, 0]);

        const xAxis = d3.axisBottom(x);
        const yAxis = d3.axisLeft(y);

        const line = d3.line()
            .x(d => x(new Date(d.date)))
            .y(d => y(d.local_price));

        d3.csv('BigmacPrice.csv').then(data => {
            const nestedData = d3.nest()
                .key(d => d.name)
                .entries(data);

            const countryData = {};

            nestedData.forEach(d => {
                const name = d.key;
                const values = d.values.map(v => {
                    return {
                        date: new Date(v.date),
                        local_price: +v.local_price
                    };
                });
                countryData[name] = values;
            });

            d3.json('europe.geojson').then(geojson => {
                const countries = topojson.feature(geojson, geojson.objects.countries);

                const projection = d3.geoMercator()
                    .fitExtent([[0, 0], [width, height]], countries);

                const path = d3.geoPath().projection(projection);

                const maxPrice = d3.max(data, d => d.local_price);
                const minPrice = d3.min(data, d => d.local_price);

                const color = d3.scaleLinear()
                    .domain([minPrice, maxPrice])
                    .range(['#ff0000', '#00ff00']);

                const map = d3.select('#map')
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height);

                map.selectAll('path')
                    .data(countries.features)
                    .enter().append('path')
                    .attr('d', path)
                    .style('fill', d => {
                        const name = d.properties.name;
                        const price = d.properties.price;
                        return color(price);
                    })
                    .on('mouseover', function (event, d) {
                        d3.select(this).style('opacity', 0.5);
                        const name = d.properties.name;
                        const price = d.properties.price;
                        d3.select('#tooltip')
                            .html(`<strong>${name}</strong><br>Price: ${price}`)
                            .classed('visible', true)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 30) + 'px');
                    })
                    .on('mouseout', function () {
                        d3.select(this).style('opacity', 1);
                        d3.select('#tooltip').classed('visible', false);
                    })
                    .on('click', function (event, d) {
                        const name = d.properties.name;
                        const values = countryData[name];
                        if (values) {
                            x.domain(d3.extent(values, d => d.date));
                            y.domain([0, d3.max(values, d => d.local_price)]);

                            d3.select('.line').remove();

                            svg.append('g')
                                .attr('class', 'x-axis')
                                .attr('transform', `translate(0,${height})`)
                                .call(xAxis);

                            svg.append('g')
                                .attr('class', 'y-axis')
                                .call(yAxis)
                                .append('text')
                                .attr('fill', '#fff')
                                .attr('transform', 'rotate(-90)')
                                .attr('y', 6)
                                .attr('dy', '0.71em')
                                .attr('text-anchor', 'end')
                                .text('Price (local currency)');

                            svg.append('path')
                                .datum(values)
                                .attr('class', 'line')
                                .attr('d', line)
                                .style('stroke', 'white')
                                .style('stroke-width', 2)
                                .style('fill', 'none');
                        }
                    });

                map.selectAll('path')
                    .data(data, d => d.name)
                    .each(function (d) {
                        const centroid = path.centroid(countries.features.find(f => f.properties.name === d.name));
                        d.properties.centroid = centroid;
                    });

                map.selectAll('text')
                    .data(data, d => d.name)
                    .enter().append('text')
                    .text(d => d.name)
                    .attr('x', d => d.properties.centroid[0])
                    .attr('y', d => d.properties.centroid[1])
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '10px')
                    .attr('fill', 'white');
            });
        });
    </script>
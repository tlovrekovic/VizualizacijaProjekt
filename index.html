<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://d3js.org/d3-geo.v1.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="https://d3js.org/d3-ease.v1.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <title>Document</title>
</head>
<body>
    <h1 class="white center padding">BigMacPrices</h1>
    <div id="mapContainer">
    </div>

    <select class="margin" id="countries">
        <option selected>Choose country...</option>
    </select>

    <script>
        const width = innerWidth;
        const height = innerHeight;
        let linechart;

        const colors = ["#2e61b8", "#2eb8a6", "#eaed87", "#8ab82e", "#b8b32e", "#b8712e", "#b8452e"];
        const colorValue = d => d.properties.economy;

        const svg = d3.select("#mapContainer").append("svg")
            .attr("id", "mapSvg")
            .attr("width", width)
            .attr("height", height * 0.95);

     
        const projection = d3.geoNaturalEarth1()
            .scale(230)
            .translate([width / 2.25, height / 2.15]);
        const pathGenerator = d3.geo.path().projection(projection);
       
        const mapGroup = svg.append('g');

        mapGroup.append('path')
            .attr('class', 'sphere')
            .attr('d', pathGenerator({type: "Sphere"}));

        
        const zoomLevelLimit = [1, 5];
        const zoom = d3.behavior.zoom().scaleExtent(zoomLevelLimit)

        svg.call(zoom.on('zoom', () => {
            mapGroup.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
        }));

        //loading data for map
        d3.json("topoJSONdata.json", function(error, topoJSONdata) {
            //loading other data for each country
            d3.csv("bigmac.csv", function(error, csvData) {
                const countries = topojson.feature(topoJSONdata, topoJSONdata.objects.countries);

                //row from file
                const rowById = {};
                csvData.forEach(d => {
                    rowById[d.iso_n3] = d;
                });

                countries.features.forEach(d => {
                    Object.assign(d.properties, rowById[d.id])
                });

                const countryNames = [];
                countries.features.forEach(item => {
                    countryNames.push(item.properties.name);
                });

                //putting countries in select element
                countryNames.sort();
                const dropDown = d3.select("#countries");
                dropDown.selectAll(null)
                    .data(countryNames)
                    .enter()
                    .append("option")
                    .attr("value", function (d) { return d; })
                    .text(function (d) { return d; });

                dropDown.on('change', function () {
                    const select = document.getElementById('countries');
                    const name = select.options[select.selectedIndex].value;
                    let country;
                    countries.features.forEach(item => {
                       if (item.properties.name === name) {
                           country = item;
                       }
                    });

                    if (typeof country !== 'undefined') {
                        const data = {
                            country: name,
                            eleven: country.properties.eleven,
                            twelwe: country.properties.twelwe,
                            thirteen: country.properties.thirteen,
                            fourteen: country.properties.fourteen,
                            fifteen: country.properties.fifteen,
                            sixteen: country.properties.sixteen,
                            seventeen: country.properties.seventeen,
                            eighteen: country.properties.eighteen,
                        }
                        makeGraphs(data);
                    }
                })

                mapGroup.selectAll('path')
                    .data(countries.features)
                    .enter()
                    .append('path')
                    .attr('class', 'country')
                    .attr('d', pathGenerator)
                    .attr('fill', d => colors[String(colorValue(d)).substring(0, 1) - 1])
                    .on('click', d => {
                        //disable click when dragging over map
                        if (d3.event.defaultPrevented) return;
                        const data = {
                            country: rowById[d.id].name,
                            eleven: rowById[d.id].eleven,
                            twelwe: rowById[d.id].twelwe,
                            thirteen: rowById[d.id].thirteen,
                            fourteen: rowById[d.id].fourteen,
                            fifteen: rowById[d.id].fifteen,
                            sixteen: rowById[d.id].sixteen,
                            seventeen: rowById[d.id].seventeen,
                            eighteen: rowById[d.id].eighteen,
                        }
                        makeGraphs(data);
                    })
                    .append('title')
                    .text(d => {
                        const name = rowById[d.id].name;
                        const continent = rowById[d.id].continent;
                        const region = rowById[d.id].region_wb;
                        const population = rowById[d.id].pop_est;
                        const popuplationModified = numberWithSpaces(parseInt(population));

                        return name + "\nContinent: " + continent + "\nRegion: " + region + "\nPopulation: " + popuplationModified;
                    })
            });    
        });

        //for displaying big numbers
        function numberWithSpaces(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }
        
        const graphSvg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height * 0.75);
        let graphGroup = graphSvg.append('g');
        let graphMade = false;
        function parseData(data) {
            if (!data.toString().includes(",")) {
                return 0;
            }
            const commmaIndex = data.toString().indexOf(",");
            const value = data.toString().substring(0, commmaIndex);
            return parseInt(parseInt(value) / 1000000000);
        }
    </script>

</body>
</html>